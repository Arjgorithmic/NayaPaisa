{% extends "base.html" %}

{% block title %}Clients - Nayapaisa{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Client Management</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">
                    <i class="bi bi-plus-lg me-1"></i> Add Client
                </button>
            </div>
            <div class="card-body">
                <!-- Search -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="clientSearch" placeholder="Search clients...">
                        </div>
                    </div>
                </div>

                <!-- Clients Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="clientsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Company</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in clients %}
                            <tr data-client-id="{{ client.id }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light rounded-circle p-2 me-2">
                                            <i class="bi bi-person text-muted"></i>
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{ client.name or 'N/A' }}</div>
                                            {% if client.address %}
                                            <div class="small text-muted">{{ client.address[:30] }}{% if client.address|length > 30 %}...{% endif %}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>{{ client.email or 'N/A' }}</td>
                                <td>{{ client.phone or 'N/A' }}</td>
                                <td>{{ client.company or 'N/A' }}</td>
                                <td>
                                    {% if client.createdAt %}
                                        {{ client.createdAt.strftime('%d %b %Y') if client.createdAt.strftime else client.createdAt|string|truncate(10, True, '') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editClient('{{ client.id }}')" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteClient('{{ client.id }}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="py-5">
                                        <i class="bi bi-people fs-1 text-muted"></i>
                                        <h4 class="mt-2">No clients found</h4>
                                        <p class="text-muted">Add your first client to get started</p>
                                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">
                                            <i class="bi bi-plus-lg me-1"></i> Add Client
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientModalLabel">Add Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="clientId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" id="clientEmail" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="clientPhone">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Company</label>
                                <input type="text" class="form-control" id="clientCompany">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="clientAddress" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveClientBtn">Save Client</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load clients on page load
document.addEventListener('DOMContentLoaded', function() {
    loadClients();
});

// Search clients
document.getElementById('clientSearch').addEventListener('input', function() {
    const query = this.value;
    if (query.length > 2) {
        searchClients(query);
    } else if (query.length === 0) {
        loadClients();
    }
});

function loadClients() {
    fetch('/api/clients')
        .then(response => response.json())
        .then(data => {
            updateClientsTable(data.clients);
        })
        .catch(error => console.error('Error:', error));
}

function searchClients(query) {
    fetch(`/api/clients/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            updateClientsTable(data.clients);
        })
        .catch(error => console.error('Error:', error));
}

function updateClientsTable(clients) {
    const tbody = document.querySelector('#clientsTable tbody');
    
    if (clients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">No clients found</td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    clients.forEach(client => {
        const row = document.createElement('tr');
        row.setAttribute('data-client-id', client.id);
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="bg-light rounded-circle p-2 me-2">
                        <i class="bi bi-person text-muted"></i>
                    </div>
                    <div>
                        <div class="fw-medium">${client.name || 'N/A'}</div>
                        ${client.address ? `<div class="small text-muted">${client.address.substring(0, 30)}${client.address.length > 30 ? '...' : ''}</div>` : ''}
                    </div>
                </div>
            </td>
            <td>${client.email || 'N/A'}</td>
            <td>${client.phone || 'N/A'}</td>
            <td>${client.company || 'N/A'}</td>
            <td>${client.createdAt ? new Date(client.createdAt).toLocaleDateString() : 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editClient('${client.id}')" title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${client.id}')" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function editClient(clientId) {
    fetch(`/api/clients/${clientId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const client = data.client;
                document.getElementById('clientId').value = client.id;
                document.getElementById('clientName').value = client.name || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientCompany').value = client.company || '';
                document.getElementById('clientAddress').value = client.address || '';
                
                document.getElementById('clientModalLabel').textContent = 'Edit Client';
                new bootstrap.Modal(document.getElementById('clientModal')).show();
            }
        })
        .catch(error => console.error('Error:', error));
}

function deleteClient(clientId) {
    if (confirm('Are you sure you want to delete this client?')) {
        fetch(`/api/clients/${clientId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadClients();
                alert('Client deleted successfully!');
            } else {
                alert('Error deleting client: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error deleting client');
        });
    }
}

// Save client
document.getElementById('saveClientBtn').addEventListener('click', function() {
    const clientId = document.getElementById('clientId').value;
    const clientData = {
        name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        company: document.getElementById('clientCompany').value,
        address: document.getElementById('clientAddress').value
    };
    
    const method = clientId ? 'PUT' : 'POST';
    const url = clientId ? `/api/clients/${clientId}` : '/api/clients';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(clientData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadClients();
            bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            document.getElementById('clientModalLabel').textContent = 'Add Client';
            alert('Client saved successfully!');
        } else {
            alert('Error saving client: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error saving client');
    });
});

// Reset modal when closed
document.getElementById('clientModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('clientForm').reset();
    document.getElementById('clientId').value = '';
    document.getElementById('clientModalLabel').textContent = 'Add Client';
});
</script>
{% endblock %}